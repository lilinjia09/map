<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç­çº§æˆå‘˜å»å‘åˆ†å¸ƒå›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/china.js"></script>
    
    <!-- åŒå­¦æ•°æ®æ–‡ä»¶ -->
    <script src="data.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #415a77 100%);
            color: #fff;
            overflow: hidden;
        }
        
        .header {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 15px 30px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .title { font-size: 24px; font-weight: bold; color: #fff; }
        .subtitle { font-size: 14px; color: #aaa; margin-top: 4px; }
        
        .stats { display: flex; gap: 20px; }
        .stat-item {
            text-align: center;
            padding: 10px 20px;
            background: rgba(255,255,255,0.08);
            border-radius: 10px;
        }
        .stat-number { font-size: 26px; font-weight: bold; color: #4fc3f7; }
        .stat-label { font-size: 12px; color: #aaa; margin-top: 3px; }
        
        #map { width: 100vw; height: 100vh; }
        
        .search-box { 
            position: fixed; 
            top: 100px;
            left: 20px; 
            z-index: 99; 
        }
        #searchInput {
            width: 300px;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 14px;
        }
        #searchInput::placeholder { color: #888; }
        #searchInput:focus { outline: none; border-color: #4fc3f7; }
        
        .tip {
            position: fixed;
            bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.75);
            padding: 12px 18px;
            border-radius: 10px;
            font-size: 13px;
            color: #aaa;
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background: linear-gradient(135deg, #1b263b 0%, #0d1b2a 100%);
            border-radius: 16px;
            width: 360px;
            box-shadow: 0 25px 60px rgba(0,0,0,0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            overflow: hidden;
        }
        .modal-header {
            position: relative;
            height: 140px;
            background: linear-gradient(135deg, #4fc3f7 0%, #2196f3 100%);
        }
        .modal-avatar {
            width: 90px; height: 90px;
            border-radius: 50%;
            border: 4px solid #fff;
            position: absolute;
            bottom: -45px;
            left: 50%;
            margin-left: -45px;
            background: #1b263b;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: #fff;
            background-size: cover;
            background-position: center;
        }
        .modal-close {
            position: absolute;
            top: 10px; right: 10px;
            width: 30px; height: 30px;
            border-radius: 50%;
            background: rgba(0,0,0,0.4);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }
        .modal-close:hover { background: rgba(244, 67, 54, 0.9); transform: rotate(90deg); }
        .modal-body { padding: 60px 25px 25px; text-align: center; }
        .modal-name { font-size: 24px; font-weight: bold; margin-bottom: 8px; color: #fff; }
        .modal-university {
            display: inline-block;
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .modal-detail {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 12px;
            background: rgba(255,255,255,0.05),
            border-radius: 8px;
            margin: 10px 0;
        }
        .detail-item { text-align: center; }
        .detail-label { font-size: 11px; color: #aaa; margin-bottom: 3px; }
        .detail-value { font-size: 13px; color: #fff; font-weight: bold; }
        .modal-message {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            font-style: italic;
            color: #ccc;
            line-height: 1.5;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="title">ğŸ“ 2021çº§å››ç­è¹­é¥­å›¾</div>
            <div class="subtitle">èšæ˜¯ä¸€å›¢ç«ï¼Œæ•£æ˜¯æ»¡å¤©æ˜Ÿ | æ»šè½®ç¼©æ”¾æŸ¥çœ‹å¯†é›†åŒºåŸŸ</div>
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalCount">0</div>
                <div class="stat-label">æ€»äººæ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="cityCount">0</div>
                <div class="stat-label">åŸå¸‚æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="universityCount">0</div>
                <div class="stat-label">é™¢æ ¡æ•°</div>
            </div>
        </div>
    </div>
    
    <div class="search-box">
        <input type="text" placeholder="ğŸ” æœç´¢å§“å/åŸå¸‚/å¤§å­¦/ä¸“ä¸š/ç­¾å..." id="searchInput" oninput="searchStudent()">
    </div>
    
    <div id="map"></div>
    
    <div class="tip">ğŸ’¡ æ»šè½®ç¼©æ”¾ | ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… | æ‹–æ‹½ç§»åŠ¨</div>
    
    <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-avatar" id="modalAvatar"></div>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="modal-name" id="modalName">å§“å</div>
                <div class="modal-university" id="modalUniversity">å¤§å­¦</div>
                <div class="modal-detail">
                    <div class="detail-item">
                        <div class="detail-label">æ‰€åœ¨åŸå¸‚</div>
                        <div class="detail-value" id="modalCity">åŸå¸‚</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä¸“ä¸š</div>
                        <div class="detail-value" id="modalMajor">ä¸“ä¸š</div>
                    </div>
                </div>
                <div class="modal-message" id="modalMessage">å¯„è¯­...</div>
            </div>
        </div>
    </div>

    <script>
        // ==================== åŸå¸‚åæ ‡æ•°æ®ï¼ˆå†…ç½®ï¼‰====================
        var cityCoords = {
            "åŒ—äº¬": [116.3912972, 39.9057136],
            "åˆè‚¥": [117.281428, 31.8665676],
            "å¨æµ·": [122.1152599, 37.5120997],
            "æˆéƒ½": [104.063315, 30.659867],
            "é•¿æ²™": [112.9708685, 28.1987538],
            "å—äº¬": [118.7788631, 32.0438284],
            "è¥¿å®‰": [108.9423363, 34.261004],
            "é•¿æ˜¥": [125.3180998, 43.8844201],
            "æ­¦æ±‰": [114.2889707, 30.5611595],
            "é’å²›": [120.3777659, 36.0663249],
            "éƒ‘å·": [113.6536663, 34.7475076],
            "ä¸Šæµ·": [121.4700152, 31.2312707],
            "è‹å·": [120.6212881, 31.311123],
            "å…‹æ‹‰ç›ä¾": [84.8867252, 45.5778068],
            "é‡åº†": [106.5842092, 29.5697328],
            "å“ˆå°”æ»¨": [126.6276177, 45.7593633],
            "æ¹˜æ½­": [112.626292, 27.681864],
            "èµ£å·": [115.348216, 25.703866],
            "ç„¦ä½œ": [113.143889, 35.1375],
            "å¤©æ´¥": [117.4163641, 39.3032619],
            "æµå—": [117.1138479, 36.6519754],
            "ä¹Œé²æœ¨é½": [87.6139038, 43.8244074],
            "çŸ³æ²³å­": [86.0775574, 44.3017013],
            "è¥¿å®": [101.440811, 36.824463],
            "æ–°ä¹¡": [114.051111, 35.308611],
            "å¼€å°": [114.497222, 34.604167],
            "å—å®": [108.3627211, 22.8193063],
            "å…°å·": [103.8485056, 36.034178],
            "ä¼Šå®": [81.666667, 44.0],
            "æ´›é˜³": [112.4477046, 34.6196539],
            "æ¸©å·": [120.695345, 27.9963899],
            "ä¹å±±": [103.5966083, 29.2233495]
        };

        var myChart = null;
        var allStudentData = [];

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥åŒå­¦æ•°æ®æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof rawData === 'undefined') {
                alert('é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒå­¦æ•°æ®ï¼Œè¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨');
                return;
            }
            
            // åˆå§‹åŒ–åœ°å›¾
            initMap();
            updateStats();
        });

        function getCityName(coords) {
            for (var city in cityCoords) {
                if (Math.abs(cityCoords[city][0] - coords[0]) < 0.01 && 
                    Math.abs(cityCoords[city][1] - coords[1]) < 0.01) {
                    return city;
                }
            }
            return 'æœªçŸ¥';
        }

        function getShortName(name) { return name ? name.slice(-2) : ''; }

        // ========== æ ¸å¿ƒç®—æ³•ï¼šåˆ†ç±»å¸ƒå±€ä¼˜åŒ– ==========
        function processMapData(data) {
            var cityGroups = {};
            data.forEach(function(item) {
                var cityName = getCityName(item.value);
                if (!cityGroups[cityName]) cityGroups[cityName] = [];
                cityGroups[cityName].push(item);
            });

            var studentPoints = [];
            var cityCenters = [];
            var lines = [];

            for (var city in cityGroups) {
                var students = cityGroups[city];
                var center = cityCoords[city];
                if (!center) continue;

                var count = students.length;

                // å­˜å‚¨åŸå¸‚ä¸­å¿ƒ
                cityCenters.push({
                    name: city,
                    value: center.concat(count),
                    count: count
                });

                // é˜ˆå€¼ï¼š> 3 ä¸ºäººå¤šçš„åŸå¸‚
                if (count > 3) {
                    var isZhengzhou = (city === "éƒ‘å·");
                    var spacing = 0.5; 

                    if (isZhengzhou) {
                        // --- éƒ‘å·ç‰¹æ®Šå¤„ç†ï¼šå³ä¾§æµ·ä¸Š ---
                        var listStartX = 128.0; 
                        var listStartY = center[1];

                        students.forEach(function(student, index) {
                            var currentY = listStartY - (index * spacing) + ((count - 1) / 2) * spacing;
                            
                            studentPoints.push({
                                name: student.name,
                                value: [listStartX, currentY],
                                ext: student.ext,
                                city: city,
                                count: count,
                                labelPosition: 'right'
                            });

                            lines.push({
                                coords: [center, [listStartX, currentY]]
                            });
                        });
                    } else {
                        // --- å…¶ä»–å¤§åŸå¸‚ï¼šå³ä¾§ ---
                        var listStartX = center[0] + 3.5; 
                        var listStartY = center[1] + ((count - 1) / 2) * spacing;

                        students.forEach(function(student, index) {
                            var currentY = listStartY - (index * spacing);
                            
                            studentPoints.push({
                                name: student.name,
                                value: [listStartX, currentY],
                                ext: student.ext,
                                city: city,
                                count: count,
                                labelPosition: 'right'
                            });

                            lines.push({
                                coords: [center, [listStartX, currentY]]
                            });
                        });
                    }

                } else {
                    // === å°åŸå¸‚æ¨¡å¼ï¼šè´´èº«å¸ƒå±€ ===
                    var smallRadius = 0.15; 

                    students.forEach(function(student, index) {
                        var angle = count === 1 ? 30 : (360 / count) * index + 30;
                        var radian = angle * (Math.PI / 180);

                        var newLng = center[0] + smallRadius * Math.cos(radian) * 1.2;
                        var newLat = center[1] + smallRadius * Math.sin(radian);

                        var labelPos = 'right';
                        var normAngle = angle < 0 ? angle + 360 : angle;
                        if (normAngle >= 315 || normAngle < 45) labelPos = 'right';
                        else if (normAngle >= 45 && normAngle < 135) labelPos = 'top';
                        else if (normAngle >= 135 && normAngle < 225) labelPos = 'left';
                        else labelPos = 'bottom';

                        studentPoints.push({
                            name: student.name,
                            value: [newLng, newLat],
                            ext: student.ext,
                            city: city,
                            count: count,
                            labelPosition: labelPos
                        });

                        lines.push({
                            coords: [center, [newLng, newLat]]
                        });
                    });
                }
            }

            return { students: studentPoints, centers: cityCenters, lines: lines };
        }

        function initMap() {
            myChart = echarts.init(document.getElementById('map'));
            
            var processed = processMapData(rawData);
            allStudentData = processed.students;

            var option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.seriesType === 'lines') return null;
                        var d = params.data;
                        var html = '<div style="font-weight:bold;font-size:15px;color:#4fc3f7;">' + d.name + '</div>';
                        if (d.ext) {
                            html += '<div style="margin:8px 0;color:#aaa;">' + d.ext.job + '</div>';
                            html += '<div style="color:#ccc;">ğŸ“ ' + d.city + '</div>';
                        } else {
                            html += '<div style="color:#ccc;">å…± ' + d.count + ' äºº</div>';
                        }
                        return html;
                    }
                },
                geo: {
                    map: 'china',
                    roam: true,
                    center: [105, 36],
                    zoom: 1.2,
                    label: { show: false },
                    itemStyle: {
                        areaColor: 'rgba(20, 30, 40, 0.9)',
                        borderColor: 'rgba(79, 195, 247, 0.2)',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: { areaColor: 'rgba(79, 195, 247, 0.2)' },
                        label: { show: false }
                    },
                    regions: [{
                        name: 'å—æµ·è¯¸å²›',
                        itemStyle: { areaColor: 'rgba(20, 30, 40, 0.3)', opacity: 0.3 }
                    }]
                },
                series: [
                    // 1. æ¸…æ™°è¿çº¿
                    {
                        type: 'lines',
                        coordinateSystem: 'geo',
                        zlevel: 1,
                        effect: { show: false },
                        lineStyle: {
                            color: '#FFD700',
                            width: 2,
                            curveness: 0,
                            opacity: 0.9
                        },
                        data: processed.lines
                    },
                    // 2. åŸå¸‚ä¸­å¿ƒï¼ˆå”¯ä¸€åœ†ç‚¹ï¼‰
                    {
                        name: 'åŸå¸‚',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: processed.centers,
                        symbol: 'circle',
                        symbolSize: 12,
                        itemStyle: {
                            color: '#fff',
                            borderWidth: 3,
                            borderColor: 'rgba(79, 195, 247, 0.9)'
                        },
                        label: {
                            show: true,
                            formatter: '{b}',
                            position: 'top',
                            color: '#fff',
                            fontSize: 13,
                            fontWeight: 'bold',
                            textBorderColor: '#000',
                            textBorderWidth: 3
                        },
                        emphasis: { scale: 1.3 }
                    },
                    // 3. åŒå­¦æ ‡ç­¾ï¼ˆæ— åœ†ç‚¹ï¼Œå­—å·14ï¼‰
                    {
                        name: 'åŒå­¦',
                        type: 'scatter',
                        coordinateSystem: 'geo',
                        data: allStudentData.map(function(item) {
                            return {
                                name: item.name,
                                value: item.value,
                                ext: item.ext,
                                city: item.city,
                                count: item.count,
                                label: { position: item.labelPosition }
                            };
                        }),
                        symbolSize: 0, 
                        itemStyle: {
                            color: 'transparent'
                        },
                        label: {
                            show: true,
                            formatter: '{b}',
                            color: '#fff',
                            fontSize: 14,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            padding: [3, 6],
                            borderRadius: 3,
                            distance: 5
                        },
                        emphasis: {
                            label: { 
                                show: true, 
                                fontWeight: 'bold', 
                                fontSize: 16,
                                backgroundColor: '#4fc3f7'
                            }
                        }
                    }
                ]
            };

            myChart.setOption(option);

            myChart.on('click', function(params) {
                if (params.seriesName === 'åŒå­¦') showStudentModal(params.data);
            });

            window.addEventListener('resize', function() { myChart.resize(); });
        }

        function updateStats() {
            document.getElementById('totalCount').textContent = rawData.length;
            var cities = new Set();
            var universities = new Set();
            rawData.forEach(function(item) {
                cities.add(getCityName(item.value));
                universities.add(item.ext.job);
            });
            document.getElementById('cityCount').textContent = cities.size;
            document.getElementById('universityCount').textContent = universities.size;
        }

        function showStudentModal(data) {
            document.getElementById('modalName').textContent = data.name;
            document.getElementById('modalUniversity').textContent = data.ext.job;
            document.getElementById('modalCity').textContent = data.city;
            document.getElementById('modalMajor').textContent = 
                (data.ext.ind && data.ext.ind !== 'nan') ? data.ext.ind : 'æœªå¡«å†™';
            document.getElementById('modalMessage').textContent = 
                (data.ext.words && data.ext.words !== 'nan') ? data.ext.words : 'æš‚æ— å¯„è¯­';
            
            var avatarEl = document.getElementById('modalAvatar');
            var shortName = getShortName(data.name);
            var photoUrl = data.ext.photo;

            if (photoUrl && photoUrl !== 'nan' && photoUrl.indexOf('ui-avatars.com') === -1) {
                avatarEl.style.backgroundImage = 'url(' + photoUrl + ')';
                avatarEl.innerText = "";
            } else {
                avatarEl.style.backgroundImage = 'none';
                avatarEl.style.backgroundColor = '#4fc3f7';
                avatarEl.innerText = shortName;
            }
            
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function closeModal(event) {
            if (!event || event.target.id === 'modalOverlay') {
                document.getElementById('modalOverlay').style.display = 'none';
            }
        }

        // æœç´¢åŠŸèƒ½ï¼šæ”¯æŒå§“åã€åŸå¸‚ã€å¤§å­¦ã€ä¸“ä¸šã€ç­¾å
        function searchStudent() {
            var keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!keyword) {
                // æœç´¢æ¡†ä¸ºç©ºæ—¶ï¼Œæ¢å¤é»˜è®¤æ˜¾ç¤º
                myChart.setOption({
                    series: [{
                        name: 'åŒå­¦',
                        data: allStudentData.map(function(item) {
                            return {
                                name: item.name,
                                value: item.value,
                                ext: item.ext,
                                city: item.city,
                                count: item.count,
                                label: { position: item.labelPosition },
                                label: {
                                    show: true,
                                    fontSize: 14,
                                    color: '#fff',
                                    backgroundColor: 'rgba(0, 0, 0, 0.7)'
                                }
                            };
                        })
                    }]
                });
                return;
            }
            
            myChart.setOption({
                series: [{
                    name: 'åŒå­¦',
                    data: allStudentData.map(function(item) {
                        // æ£€æŸ¥å¤šä¸ªå­—æ®µ
                        var nameMatch = item.name.toLowerCase().includes(keyword);
                        var cityMatch = item.city.toLowerCase().includes(keyword);
                        var jobMatch = item.ext.job.toLowerCase().includes(keyword);
                        var indMatch = (item.ext.ind && item.ext.ind !== 'nan') ? 
                                       item.ext.ind.toLowerCase().includes(keyword) : false;
                        var wordsMatch = (item.ext.words && item.ext.words !== 'nan') ? 
                                         item.ext.words.toLowerCase().includes(keyword) : false;
                        
                        var isMatch = nameMatch || cityMatch || jobMatch || indMatch || wordsMatch;
                        
                        return {
                            name: item.name,
                            value: item.value,
                            ext: item.ext,
                            city: item.city,
                            count: item.count,
                            label: { position: item.labelPosition },
                            label: {
                                show: true,
                                fontSize: 14,
                                color: isMatch ? '#fff' : 'rgba(150, 150, 150, 0.5)',
                                backgroundColor: isMatch ? 'rgba(255, 87, 34, 0.9)' : 'rgba(0, 0, 0, 0.4)',
                                fontWeight: isMatch ? 'bold' : 'normal'
                            }
                        };
                    })
                }]
            });
        }
    </script>
</body>
</html>
